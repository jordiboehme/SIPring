{% extends "base.html" %}

{% block title %}Event Log - SIPring{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">Event Log</h1>
        <p class="page-subtitle">Ring event history</p>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: var(--space-5);">
    <div class="card-body">
        <form id="eventFilters" class="filter-bar" onsubmit="filterEvents(); return false;">
            <div class="filter-group">
                <label class="form-label" for="filter-range">Time Range</label>
                <select id="filter-range" class="form-control" style="width: auto; min-width: 140px;">
                    <option value="24h"{% if filter_range == '24h' %} selected{% endif %}>Last 24 hours</option>
                    <option value="7d"{% if filter_range == '7d' %} selected{% endif %}>Last 7 days</option>
                    <option value="30d"{% if filter_range == '30d' %} selected{% endif %}>Last 30 days</option>
                    <option value="all"{% if filter_range == 'all' %} selected{% endif %}>All time</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="form-label" for="filter-config">Configuration</label>
                <select id="filter-config" class="form-control" style="width: auto; min-width: 160px;">
                    <option value="">All configs</option>
                    {% for config in configs %}
                    <option value="{{ config.id }}"{% if filter_config_id == config.id|string %} selected{% endif %}>{{ config.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="form-label" for="filter-result">Result</label>
                <select id="filter-result" class="form-control" style="width: auto; min-width: 130px;">
                    <option value="">All results</option>
                    <option value="completed"{% if filter_result == 'completed' %} selected{% endif %}>Completed</option>
                    <option value="cancelled"{% if filter_result == 'cancelled' %} selected{% endif %}>Cancelled</option>
                    <option value="answered"{% if filter_result == 'answered' %} selected{% endif %}>Answered</option>
                    <option value="timeout"{% if filter_result == 'timeout' %} selected{% endif %}>Timeout</option>
                    <option value="error"{% if filter_result == 'error' %} selected{% endif %}>Error</option>
                    <option value="busy"{% if filter_result == 'busy' %} selected{% endif %}>Busy</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="form-label" for="filter-type">Type</label>
                <select id="filter-type" class="form-control" style="width: auto; min-width: 110px;">
                    <option value="">All types</option>
                    <option value="ring"{% if filter_trigger_type == 'ring' %} selected{% endif %}>Ring</option>
                    <option value="test"{% if filter_trigger_type == 'test' %} selected{% endif %}>Test</option>
                </select>
            </div>
            <div class="filter-group" style="align-self: flex-end;">
                <button type="submit" class="btn btn-primary btn-sm">
                    <svg><use href="#icon-eye"></use></svg>
                    Apply
                </button>
            </div>
        </form>
    </div>
</div>

{% if events %}
<!-- Events Table -->
<div class="card">
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Configuration</th>
                    <th>Result</th>
                    <th>Duration</th>
                    <th>Source IP</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr>
                    <td style="white-space: nowrap;">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ event.config_name }}</td>
                    <td>
                        {% if event.result %}
                        <span class="badge {{ result_badge_map.get(event.result, 'badge-info') }}">{{ event.result }}</span>
                        {% else %}
                        <span class="badge badge-info">pending</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if event.duration_actual is not none %}
                        {{ "%.1f"|format(event.duration_actual) }}s
                        {% else %}
                        {{ event.duration }}s
                        {% endif %}
                    </td>
                    <td style="font-family: var(--font-mono, monospace); font-size: var(--text-xs);">{{ event.source_ip or '-' }}</td>
                    <td>
                        {% if event.trigger_type == 'test' %}
                        <span class="badge badge-info">test</span>
                        {% else %}
                        <span class="badge badge-success">ring</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total > limit %}
<div class="pagination" style="display: flex; align-items: center; justify-content: space-between; margin-top: var(--space-4);">
    <span style="font-size: var(--text-sm); color: var(--text-secondary);">
        Showing {{ offset + 1 }}&ndash;{{ [offset + limit, total]|min }} of {{ total }} events
    </span>
    <div style="display: flex; gap: var(--space-2);">
        {% if offset > 0 %}
        <button class="btn btn-secondary btn-sm" onclick="loadPage({{ [offset - limit, 0]|max }})">
            <svg><use href="#icon-arrow-left"></use></svg>
            Previous
        </button>
        {% endif %}
        {% if offset + limit < total %}
        <button class="btn btn-secondary btn-sm" onclick="loadPage({{ offset + limit }})">
            Next
            <svg style="transform: rotate(180deg);"><use href="#icon-arrow-left"></use></svg>
        </button>
        {% endif %}
    </div>
</div>
{% elif total > 0 %}
<div style="margin-top: var(--space-4); font-size: var(--text-sm); color: var(--text-secondary);">
    {{ total }} event{{ 's' if total != 1 else '' }} total
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="card">
    <div class="empty-state">
        <svg><use href="#icon-clock"></use></svg>
        <h2 class="empty-state-title">No events found</h2>
        <p class="empty-state-message">
            {% if filter_range != 'all' or filter_config_id or filter_result or filter_trigger_type %}
            Try adjusting your filters or selecting a wider time range.
            {% else %}
            Ring events will appear here once you trigger a ring.
            {% endif %}
        </p>
    </div>
</div>
{% endif %}
{% endblock %}
